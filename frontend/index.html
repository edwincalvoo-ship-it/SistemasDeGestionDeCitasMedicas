<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Citas Médicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Transiciones suaves para cambios de contenido */
        .quick-action-card {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Ocultar dashboard inicialmente para evitar flash */
        #dashboard-section.initializing {
            opacity: 0;
        }
        
        #dashboard-section.ready {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-blue-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <i class="fas fa-hospital-alt text-3xl"></i>
                        <div>
                            <h1 class="text-2xl font-bold">Sistema de Gestión de Citas Médicas</h1>
                            <p class="text-blue-100 text-sm">Gestión integral de pacientes, doctores y citas</p>
                        </div>
                    </div>
                    <div id="user-info" class="hidden flex items-center space-x-4">
                        <a href="perfil.html" class="text-blue-100 hover:text-white transition">
                            <i class="fas fa-user-circle text-2xl"></i>
                        </a>
                        <span id="user-email" class="mr-4"></span>
                        <button onclick="logout()" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-8">
            <!-- Login Section -->
            <div id="login-section" class="max-w-md mx-auto">
                <div class="bg-white rounded-lg shadow-md p-8">
                    <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">
                        <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión
                    </h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">Correo Electrónico</label>
                            <input type="email" id="email" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 font-medium mb-2">Contraseña</label>
                            <input type="password" id="password" required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                            <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesión
                        </button>
                        <div id="login-error" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded"></div>
                        
                        <div class="mt-4 text-center">
                            <p class="text-gray-600 text-sm">¿No tienes cuenta?</p>
                            <button type="button" onclick="showRegistroModal()" class="mt-2 text-blue-600 hover:text-blue-700 font-medium">
                                <i class="fas fa-user-plus mr-1"></i>Registrarse como Paciente
                            </button>
                        </div>
                    </form>

                    <div class="mt-6 p-4 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-600 mb-2">Usuarios de prueba:</p>
                        <ul class="text-xs text-gray-500 space-y-1">
                            <li><strong>Admin:</strong> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="2041444d494e60434c494e4943410e434f4d">[email&#160;protected]</a> / admin123</li>
                            <li><strong>Doctor:</strong> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f09391829c9f83de82919d9982958ab0939c999e999391de939f9d">[email&#160;protected]</a> / doctor123</li>
                            <li><strong>Paciente:</strong> <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="345e41555a1a445146514e745159555d581a575b59">[email&#160;protected]</a> / paciente123</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="hidden initializing">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Module Cards -->
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200 cursor-pointer" onclick="window.location.href='pacientes.html'">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Pacientes</p>
                                <h3 id="stat-pacientes" class="text-3xl font-bold text-blue-600">0</h3>
                            </div>
                            <i class="fas fa-users text-4xl text-blue-600"></i>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200 cursor-pointer" onclick="window.location.href='doctores.html'">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Doctores</p>
                                <h3 id="stat-doctores" class="text-3xl font-bold text-green-600">0</h3>
                            </div>
                            <i class="fas fa-user-md text-4xl text-green-600"></i>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200 cursor-pointer" onclick="window.location.href='gestionar-citas.html'">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Citas Hoy</p>
                                <h3 id="stat-citas" class="text-3xl font-bold text-purple-600">0</h3>
                            </div>
                            <i class="fas fa-calendar-check text-4xl text-purple-600"></i>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200 cursor-pointer" onclick="window.location.href='facturas.html'">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm font-medium">Pendientes</p>
                                <h3 id="stat-pendientes" class="text-3xl font-bold text-orange-600">0</h3>
                            </div>
                            <i class="fas fa-clock text-4xl text-orange-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-clock mr-2"></i>Actividad Reciente
                    </h3>
                    <div id="recent-activity" class="space-y-3">
                        <p class="text-center text-gray-500 py-4">Cargando actividad...</p>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div id="quick-actions" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- Admin: Registro de usuarios -->
                    <a href="pacientes.html" id="action-registro-usuarios" class="quick-action-card block bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Registro de Usuarios</h3>
                        <p class="text-blue-100">Registrar pacientes en el sistema</p>
                    </a>

                    <!-- Admin: Registro de doctores -->
                    <a href="doctores.html" id="action-registro-doctores" class="quick-action-card block bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Registro de Doctores</h3>
                        <p class="text-green-100">Administrar doctores y especialidades</p>
                    </a>

                    <!-- Admin: Gestión de Horarios -->
                    <a href="horarios.html" id="action-gestion-horarios" class="quick-action-card block bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Gestión de Horarios</h3>
                        <p class="text-indigo-100">Administrar horarios médicos</p>
                    </a>

                    <!-- Público: Consulta de horarios -->
                    <a href="consulta-horarios.html" id="action-consulta-horarios" class="quick-action-card block bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Consulta de Horarios</h3>
                        <p class="text-teal-100">Ver horarios de doctores</p>
                    </a>

                    <!-- Admin/Paciente: Agendamiento de citas -->
                    <a href="agendar-cita.html" id="action-agendamiento-citas" class="quick-action-card block bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Agendamiento de Citas</h3>
                        <p class="text-purple-100">Programar nuevas citas médicas</p>
                    </a>

                    <!-- Admin/Doctor: Gestión de Citas Médicas (NUEVO) -->
                    <a href="gestionar-citas.html" id="action-gestion-citas" class="quick-action-card block bg-gradient-to-r from-violet-500 to-violet-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Gestión de Citas Médicas</h3>
                        <p class="text-violet-100">Administrar y editar citas</p>
                    </a>


                    <!-- Todos: Consulta de Citas Médicas -->
                    <a href="mis-citas.html" id="action-consulta-citas" class="quick-action-card block bg-gradient-to-r from-cyan-500 to-cyan-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Consulta de Citas Médicas</h3>
                        <p class="text-cyan-100">Ver mis citas médicas</p>
                    </a>

                    <!-- Admin: Generación de Factura -->
                    <a href="facturas.html" id="action-generacion-factura" class="quick-action-card block bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Generación de Factura</h3>
                        <p class="text-orange-100">Generar y administrar facturas</p>
                    </a>

                    <!-- Admin/Doctor: Reportes -->
                    <a href="reportes.html" id="action-reportes" class="quick-action-card block bg-gradient-to-r from-gray-700 to-gray-800 text-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                        <h3 class="text-xl font-bold mb-2">Reportes</h3>
                        <p class="text-gray-300">Ver estadísticas y gráficos</p>
                    </a>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-12">
            <div class="container mx-auto px-4 py-6 text-center">
                <p>&copy; 2025 Sistema de Gestión de Citas Médicas. Todos los derechos reservados.</p>
            </div>
        </footer>
    </div>

    <!-- Modal de Registro -->
    <div id="modal-registro" class="hidden fixed inset-0 bg-black bg-opacity-0 flex items-center justify-center z-50 overflow-y-auto transition-all duration-300">
        <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 my-8 transform scale-95 opacity-0 transition-all duration-300">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-user-plus mr-2 text-blue-600"></i>Registro de Paciente
                </h2>
                <button onclick="closeRegistroModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <form id="form-registro" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Nombre*</label>
                    <input type="text" id="reg-nombre" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Apellido*</label>
                    <input type="text" id="reg-apellido" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Documento*</label>
                    <input type="text" id="reg-documento" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Este será tu contraseña de acceso</p>
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Correo*</label>
                    <input type="email" id="reg-correo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Teléfono*</label>
                    <input type="tel" id="reg-telefono" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Fecha de Nacimiento*</label>
                    <input type="date" id="reg-fecha-nacimiento" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 font-medium mb-2">Dirección</label>
                    <input type="text" id="reg-direccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg transition duration-200">
                        <i class="fas fa-save mr-2"></i>Registrarse
                    </button>
                </div>
            </form>
            <div id="registro-message" class="hidden mt-4 p-4 rounded"></div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/utils.js"></script>
    <script>
        async function loadDashboardStats() {
            try {
                const pacientesRes = await apiFetch(API_ENDPOINTS.pacientes);
                if (pacientesRes.success) {
                    document.getElementById('stat-pacientes').textContent = pacientesRes.data.length;
                }

                const doctoresRes = await apiFetch(API_ENDPOINTS.doctores);
                if (doctoresRes.success) {
                    document.getElementById('stat-doctores').textContent = doctoresRes.data.length;
                }

                const citasRes = await apiFetch(API_ENDPOINTS.citas);
                if (citasRes.success) {
                    const hoy = new Date().toISOString().split('T')[0];
                    const citasHoy = citasRes.data.filter(c => c.fecha === hoy);
                    document.getElementById('stat-citas').textContent = citasHoy.length;
                    loadRecentActivity(citasRes.data);
                }

                const citasPendientes = await apiFetch(API_ENDPOINTS.citas);
                if (citasPendientes.success) {
                    const pendientes = citasPendientes.data.filter(c => 
                        c.estado === 'pendiente' || c.estado === 'confirmada'
                    );
                    document.getElementById('stat-pendientes').textContent = pendientes.length;
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        function loadRecentActivity(citas) {
            const container = document.getElementById('recent-activity');
            const recent = citas.slice(0, 5);
            
            if (recent.length > 0) {
                container.innerHTML = recent.map(c => {
                    const estadoIcon = {
                        'pendiente': 'fa-clock text-yellow-500',
                        'confirmada': 'fa-check-circle text-blue-500',
                        'completada': 'fa-check-double text-green-500',
                        'cancelada': 'fa-times-circle text-red-500'
                    };
                    
                    return `
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <i class="fas ${estadoIcon[c.estado] || 'fa-circle text-gray-400'} text-xl mr-4"></i>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">${c.paciente}</p>
                                <p class="text-sm text-gray-600">Dr. ${c.doctor} - ${c.fecha} ${c.hora}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700">${c.estado}</span>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">No hay actividad reciente</p>';
            }
        }

        function personalizarDashboard() {
            if (typeof Permissions === 'undefined') return;
            
            const user = Permissions.getCurrentUser();
            if (!user) return;

            const rol = user.rol;

            // Ocultar todas las opciones por defecto
            const todasAcciones = [
                'action-registro-usuarios',
                'action-registro-doctores', 
                'action-gestion-horarios',
                'action-consulta-horarios',
                'action-agendamiento-citas',
                'action-gestion-citas',
                'action-listas-citas',
                'action-consulta-citas',
                'action-generacion-factura',
                'action-reportes'
            ];

            // Definir qué ve cada rol
            let accionesPermitidas = [];

            if (rol === 'admin') {
                // ADMIN: ve todo
                accionesPermitidas = [
                    'action-registro-usuarios',
                    'action-registro-doctores',
                    'action-gestion-horarios',
                    'action-consulta-horarios',
                    'action-agendamiento-citas',
                    'action-gestion-citas',
                    'action-listas-citas',
                    'action-consulta-citas',
                    'action-generacion-factura',
                    'action-reportes'
                ];
            } else if (rol === 'doctor') {
                // DOCTOR: gestión de citas, listas y consulta
                accionesPermitidas = [
                    'action-consulta-horarios',
                    'action-gestion-citas',
                    'action-listas-citas',
                    'action-consulta-citas',
                    'action-reportes'
                ];
            } else if (rol === 'paciente') {
                // PACIENTE: solo agendar citas y consultar horarios
                accionesPermitidas = [
                    'action-consulta-horarios',
                    'action-agendamiento-citas'
                ];
            }

            // Ocultar acciones no permitidas
            todasAcciones.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    if (accionesPermitidas.includes(id)) {
                        elemento.style.display = 'block';
                    } else {
                        elemento.style.display = 'none';
                    }
                }
            });

            // Ajustar grid según cantidad de elementos visibles
            const quickActions = document.getElementById('quick-actions');
            if (quickActions) {
                const cantidadVisible = accionesPermitidas.length;
                quickActions.classList.remove('md:grid-cols-2', 'md:grid-cols-3', 'md:grid-cols-4');
                
                if (cantidadVisible <= 2) {
                    quickActions.classList.add('md:grid-cols-2');
                } else if (cantidadVisible <= 3) {
                    quickActions.classList.add('md:grid-cols-3');
                } else {
                    quickActions.classList.add('md:grid-cols-4');
                }
            }
        }

        // Mejorar showDashboard para transiciones suaves
        const originalShowDashboard = showDashboard;
        showDashboard = function() {
            const dashboardSection = document.getElementById('dashboard-section');
            
            // Mantener dashboard oculto mientras personalizamos
            dashboardSection.classList.add('initializing');
            
            // Personalizar PRIMERO (mientras está oculto)
            personalizarDashboard();
            
            // Mostrar el dashboard con la función original
            originalShowDashboard();
            
            // Pequeño delay para asegurar que el DOM esté listo, luego hacer visible con transición
            setTimeout(() => {
                dashboardSection.classList.remove('initializing');
                dashboardSection.classList.add('ready');
            }, 50);
            
            // Cargar estadísticas después
            loadDashboardStats();
        };

        // Funciones del modal de registro
        function showRegistroModal() {
            const modal = document.getElementById('modal-registro');
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    modal.classList.add('bg-opacity-50');
                    const content = modal.querySelector('.bg-white');
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                });
            });
        }

        function closeRegistroModal() {
            const modal = document.getElementById('modal-registro');
            modal.classList.remove('bg-opacity-50');
            modal.classList.add('bg-opacity-0');
            const content = modal.querySelector('.bg-white');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        document.getElementById('form-registro').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const documento = document.getElementById('reg-documento').value;
            const correo = document.getElementById('reg-correo').value;
            
            const data = {
                nombre: document.getElementById('reg-nombre').value,
                apellido: document.getElementById('reg-apellido').value,
                documento: documento,
                correo: correo,
                telefono: document.getElementById('reg-telefono').value,
                fecha_nacimiento: document.getElementById('reg-fecha-nacimiento').value,
                direccion: document.getElementById('reg-direccion').value || null
            };
            
            const result = await apiFetch(API_ENDPOINTS.registrarPaciente, {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.success) {
                // Mostrar credenciales en pop-up bonito
                const credenciales = `
                    <div class="bg-green-100 border-l-4 border-green-500 p-4">
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-500 text-2xl mr-3 mt-1"></i>
                            <div>
                                <p class="font-bold text-green-800 mb-2">¡Registro Exitoso!</p>
                                <p class="text-green-700 mb-3">Tus credenciales de acceso son:</p>
                                <div class="bg-white p-3 rounded border border-green-200">
                                    <p class="text-sm mb-1"><strong>Correo:</strong> ${correo}</p>
                                    <p class="text-sm"><strong>Contraseña:</strong> ${documento}</p>
                                </div>
                                <p class="text-sm text-green-600 mt-3">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Por seguridad, guarda estas credenciales
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('registro-message').innerHTML = credenciales;
                document.getElementById('registro-message').classList.remove('hidden');
                document.getElementById('form-registro').reset();
                
                // Auto-llenar el login después de 5 segundos
                setTimeout(() => {
                    closeRegistroModal();
                    document.getElementById('email').value = correo;
                    document.getElementById('password').value = documento;
                }, 5000);
            } else {
                document.getElementById('registro-message').className = 'mt-4 p-4 rounded bg-red-100 text-red-700';
                document.getElementById('registro-message').textContent = result.mensaje;
                document.getElementById('registro-message').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>